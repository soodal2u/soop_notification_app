# 코드 설명 (Code Explanation)

이 문서는 SOOP 방송 알림 앱의 주요 코드와 작동 원리를 설명합니다.

## 1. `lib/main.dart`
앱의 시작점입니다.

- **13~26번 줄 (`main` 함수)**:
    - `NotificationService.initialize()`: 로컬 알림 기능을 초기화합니다.
    - `BackgroundService.initializeService()`: 백그라운드 서비스(30초 주기 작업)를 초기 설정합니다. 아직 실행은 되지 않으며 구성만 완료합니다.
    - 권한 확인 화면(`PermissionCheckScreen`)으로 이동합니다.

- **55~65번 줄 (`_checkPermissions` 함수)**:
    - `Permission.notification.request()`: Android 13 이상에서 필요한 알림 권한을 사용자에게 요청합니다.
    - 권한 처리가 끝나면 `HomeScreen`(메인 화면)으로 화면을 전환합니다.

## 2. `lib/services/background_service.dart`
앱이 켜져 있거나 꺼져 있을 때도 계속 돌아가는 백그라운드 서비스 로직입니다.

- **51번 줄 (`onStart` 함수)**:
    - 백그라운드 서비스가 시작될 때 호출되는 진입점입니다. 이 코드는 메인 앱과는 별도의 메모리 공간(Isolate)에서 실행됩니다.
    - `stopService` 이벤트를 리스닝하여 사용자가 서비스를 끄면 종료하도록 설정되어 있습니다.

- **55~74번 줄 (`Timer.periodic`)**:
    - **핵심 로직**: 정확히 **30초마다** `_checkBroadcasts` 함수를 실행합니다.
    - 타이머가 돌 때마다 API를 호출하여 방송 상태를 확인합니다.
    - **중요**: 매번 `SharedPreferences.getInstance()`와 `prefs.reload()`를 호출하여 포그라운드 앱에서 변경한 설정을 동기화합니다.

- **76~150번 줄 (`_checkBroadcasts` 함수)**:
    - **`prefs.reload()`**: 포그라운드 앱(메인 앱)에서 사용자가 변경한 알림 ON/OFF 설정을 동기화합니다. 이것이 없으면 백그라운드 서비스가 오래된 데이터를 사용하게 됩니다.
    - `SharedPreferences`에서 저장된 방송인 목록(`streamers`)을 불러옵니다.
    - 각 방송인에 대해 `ApiService.fetchBroadcastInfo`를 호출합니다.
    - 방송 중(`isBroadcasting == true`)이고, 방송 번호(`broadNo`)가 이전과 다르다면 새 방송으로 간주하여 알림(`NotificationService.showNotification`)을 보냅니다.

## 3. `lib/services/api_service.dart`
SOOP(아프리카TV) 서버와 통신하는 역할을 합니다.

- **27번 줄 (`fetchBroadcastInfo` 함수)**:
    - `https://bjapi.afreecatv.com/api/{아이디}/station` 주소로 요청을 보냅니다.
    - 응답 데이터에서 `broad` 필드가 있으면 방송 중, 없으면 방송 종료 상태로 판단합니다.
    - 닉네임, 프로필 이미지 URL 등의 정보도 함께 파싱하여 반환합니다.

## 4. `lib/services/notification_service.dart`
알림을 띄우고, 알림 클릭 시 동작을 처리합니다.

- **60~75번 줄 (`showNotification` 함수)**:
    - 휴대폰 상단에 알림을 띄웁니다.
    - `payload`에 `채널ID/방송번호` 정보를 담아 알림 클릭 시 어떤 방송인지 알 수 있게 합니다.

- **89~110번 줄 (`_openBroadcast` 함수)**:
    - 사용자가 알림을 클릭했을 때 실행됩니다.
    - `launchUrl`을 사용하여 방송 링크를 엽니다.
    - `mode: LaunchMode.externalApplication` 옵션을 사용하여, 스마트폰에 SOOP 앱이 설치되어 있다면 앱으로 연결을 시도하고, 실패하면 브라우저로 엽니다.

## 5. `lib/screens/home_screen.dart`
사용자가 보는 메인 화면입니다.

- **방송인 추가**: 다이얼로그에 ID를 입력하면 API를 통해 닉네임을 확인하고 목록에 추가합니다.
- **서비스 토글**: 우측 상단 스위치를 통해 백그라운드 서비스를 켜거나 꿀 수 있습니다. 켜면 즉시 상단바에 "방송 모니터링 중" 알림이 뜨며 30초 주기가 시작됩니다.
- **35~43번 줄 (`_checkForUpdates` 함수)**: 앱 시작 2초 후 GitHub에서 최신 버전 정보를 확인하고, 새 버전이 있으면 업데이트 다이얼로그를 표시합니다.

## 6. `lib/services/update_service.dart`
앱 업데이트 확인 서비스입니다.

- **38~52번 줄 (`checkForUpdate` 함수)**:
    - GitHub의 `version.json` 파일을 가져와 최신 버전 정보(버전, 빌드번호, 다운로드URL, 릴리즈노트)를 파싱합니다.

- **55~68번 줄 (`isUpdateAvailable` 함수)**:
    - `package_info_plus` 패키지로 현재 앱의 빌드 번호를 가져옵니다.
    - 서버의 빌드 번호와 비교하여 업데이트 필요 여부를 반환합니다.

- **71~93번 줄 (`showUpdateDialogIfNeeded` 함수)**:
    - 새 버전이 있으면 `_UpdateDialog` 위젯을 다이얼로그로 표시합니다.
    - `forceUpdate`가 true이면 "나중에" 버튼 없이 필수 업데이트로 표시됩니다.

- **96~200번 줄 (`_UpdateDialog` 위젯)**:
    - 현재 버전 → 최신 버전을 시각적으로 보여주는 UI입니다.
    - "업데이트" 버튼 클릭 시 `url_launcher`를 통해 APK 다운로드 링크로 이동합니다.

## 8. `lib/models/app_settings.dart`
앱의 모든 설정 정보를 담고 관리하는 모델입니다.

- **설정 항목**: 체크 주기, 알림 소리/진동 여부, 방해 금지 모드(DND), 방해 금지 시간, 테마 설정 등을 포함합니다.
- **`load()` / `save()`**: `SharedPreferences`를 이용해 설정을 영구 저장하고 불러옵니다.
- **`isInDndTime()`**: 현재 시간이 방해 금지 시간대에 속하는지 판단하여 `true`/`false`를 반환합니다.

## 9. `lib/screens/settings_screen.dart`
앱 설정 화면 UI입니다.

- **기능 구현**:
    - **체크 주기**: 슬라이더를 통해 API 요청 주기를 설정합니다 (10초 ~ 120초).
    - **알림 설정**: 스위치를 통해 소리와 진동을 켜고 끌 수 있습니다.
    - **방해 금지 모드**: 특정 시간대에는 알림이 울리지 않도록 설정합니다.
    - **테마 설정**: 다크/라이트/시스템 모드를 선택하여 앱의 전체적인 색상을 변경합니다.
    - **체인지 로그**: `assets/changelog.json` 파일을 읽어 업데이트 내역을 보여줍니다.
    - **데이터 초기화**: 앱의 모든 설정과 등록된 방송인 데이터를 삭제하고 초기 상태로 되돌립니다.

## 10. `lib/screens/home_screen.dart` (기능 확장)
메인 화면에 다양한 편의 기능이 추가되었습니다.

- **카드 슬라이드 기능 (`flutter_slidable` 패키지)**:
    - **왼쪽 → 오른쪽 스와이프**: 해당 방송인을 목록에서 **삭제**합니다. (배경색: 빨강)
    - **오른쪽 → 왼쪽 스와이프**: 해당 방송인의 알림을 **켜거나 끕니다**. (배경색: 주황/초록)
- **순서 변경**: 목록의 아이템을 길게 눌러 드래그 앤 드롭으로 순서를 바꿀 수 있습니다. (`ReorderableListView` 사용)
- **설정 버튼**: 앱바 상단의 톱니바퀴 아이콘을 눌러 설정 화면으로 이동합니다.

